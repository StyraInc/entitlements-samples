<!-- Copyright 2022 Styra Inc. All rights reserved. -->
<!-- Use of this source code is governed by an Apache2 -->
<!-- license that can be found in the LICENSE file. -->

<script src="https://kit.fontawesome.com/444f16dd67.js" crossorigin="anonymous"></script>
<script>
    const WATCHER_INTERVAL_MS = 500
    const TIMEDELTA_MEDIUM = 60*2
    const TIMEDELTA_LONG = 60*5

    var lastBundleCount = -1
    var refreshedTimestamp = null
    var editWatcherIndex = null
    var watcherList = [
      {
        "subject": "alice",
        "action": "GET",
        "resource": "/cars",
        "body": ""
      }, {
        "subject": "bob",
        "action": "GET",
        "resource": "/cars/car0",
        "body": ""
      }, {
        "subject": "bob",
        "action": "POST",
        "resource": "/cars",
        "body": ""
      }, {
        "subject": "",
        "action": "",
        "resource": "/entz-playground/buttons/samples",
        "body": ""
      }, {
        "subject": "",
        "action": "",
        "resource": "/entz-playground/buttons/copy",
        "body": ""
      }, {
        "subject": "",
        "action": "",
        "resource": "/entz-playground/buttons/remove",
        "body": ""
      }
    ]

    function renderAllWatchers() {
      var watchTable = document.getElementById("watchingTable")
      watchTable.innerHTML = ''

      // render header
      const headerRow = document.createElement("tr")
      headerRow.innerHTML = `<th>Subject</th>`
      headerRow.innerHTML += `<th>Action</th>`
      headerRow.innerHTML += `<th>Resource</th>`
      headerRow.innerHTML += `<th>Body</th>`
      headerRow.innerHTML += `<th>Status</th>`
      watchTable.appendChild(headerRow)

      watcherList.forEach((singleWatcher, index) => {
        const watchRow = document.createElement("tr")

        const subject  = singleWatcher["subject"]
        const action   = singleWatcher["action"]
        const resource = singleWatcher["resource"]
        const body     = singleWatcher["body"]

        watchRow.className = "watcher"
        watchRow.setAttribute("data-watcher", index)
        watchRow.innerHTML =  `<td class=watcher data-watcher=${index} data-watcher-item=subject>${subject}</td>`
        watchRow.innerHTML += `<td class=watcher data-watcher=${index} data-watcher-item=action>${action}</td>`
        watchRow.innerHTML += `<td class=watcher data-watcher=${index} data-watcher-item=resource>${resource}</td>`
        watchRow.innerHTML += `<td class=watcher data-watcher=${index} data-watcher-item=body>${body}</td>`
        watchRow.innerHTML += `<td class=watcher data-watcher=${index} data-watcher-item=allowed>...</td>`
        watchRow.innerHTML += `<td class="watcher control_buttons" data-watcher=${index}><button class=copy_button type="button" onclick="editWatcher(${index})">Edit</button> <button class=remove_button type="button" onclick="deleteWatcher(${index})"><i class="fa-solid fa-trash-can"></i></button></td>`

        watchTable.appendChild(watchRow)
      })

      // Force a new set of decisions
      lastBundleCount = -1
    }


    function getDecision(subject, action, resource, body, callback, user) {
        // Runs the callback with arguments (code, data, user) once the request
        // returns. The user field is used to exfiltrate data across callback
        // boundaries in certain contexts.

        var xhr = new XMLHttpRequest()
        xhr.open("POST", "/submit")
        xhr.setRequestHeader("Content-Type", "application/json")

        obj = {}
        if (subject  != null) {obj["subject"]  = subject}
        if (action   != null) {obj["action"]   = action}
        if (resource != null) {obj["resource"] = resource}
        if (body     != null) {obj["body"]     = body}

        xhr.send(JSON.stringify(obj))

        // This nested function stuff is needed because other wise the
        // user-provided data dosen't make it to the inside of the
        // onreadystate change callback.
        xhr.onreadystatechange = (function (user, callback) {
            return function() {
                if (this.readyState != 4) { return }
                callback(this.status, JSON.parse(this.responseText), user)
            }
        })(user, callback)
    }

    function highlight(code, language, callback) {
        var xhr = new XMLHttpRequest()
        xhr.open("PUT", `/highlight/${language}`)
        xhr.setRequestHeader("Content-Type", "text/plain")
        xhr.send(code)

        // This nested function stuff is needed because other wise the
        // user-provided data dosen't make it to the inside of the
        // onreadystate change callback.
        xhr.onreadystatechange = function () {
                if (this.readyState != 4) { return }
                callback(this.responseText)
        }
    }

    function bundle_count(callback) {
        var xhr = new XMLHttpRequest()
        xhr.open("GET", "/bundle-count")
        xhr.send()

        // This nested function stuff is needed because other wise the
        // user-provided data dosen't make it to the inside of the
        // onreadystate change callback.
        xhr.onreadystatechange = function () {
                if (this.readyState != 4) { return }
                callback(JSON.parse(this.responseText))
        }
    }

    function bundle_timestamp(callback) {
        var xhr = new XMLHttpRequest()
        xhr.open("GET", "/bundle-time")
        xhr.send()

        // This nested function stuff is needed because other wise the
        // user-provided data dosen't make it to the inside of the
        // onreadystate change callback.
        xhr.onreadystatechange = function () {
                if (this.readyState != 4) { return }
                callback(JSON.parse(this.responseText))
        }
    }

    function onPreview() {
        var subject = document.getElementById("subjectInput").value
        var action = document.getElementById("actionInput").value
        var resource = document.getElementById("resourceInput").value
        var body = document.getElementById("bodyInput").value

        if (subject  == "") {subject  = null}
        if (action   == "") {action   = null}
        if (resource == "") {resource = null}
        if (body     == "") {body     = null}

        getDecision(subject, action, resource, body, function(code, data, user) {

            const resultsDiv = document.getElementById("results")
            resultsDiv.innerHTML = ''
            const resultsH2 = document.createElement("h2")
            resultsH2.innerHTML = "Results"
            resultsDiv.appendChild(resultsH2)

            if (code >= 400) {
                const errorMsg = document.createElement("p")
                errorMsg.innerHTML = `ERROR: backend returned status code ${this.status}`
                resultsDiv.appendChild(errorMsg)
                return
            }

            if (data.error != "") {
                const errH3 = document.createElement("h3")
                errH3.innerHTML = "Error"
                resultsDiv.appendChild(errH3)

                const errCode = document.createElement("code")
                errCode.innerHTML = data.error
                resultsDiv.appendChild(errCode)
            }

            const allowedH3 = document.createElement("h3")
            allowedH3.innerHTML = `Allowed: ${data.allowed}`
            if (data.allowed) {
                allowedH3.className = "allowed"
            } else {
                allowedH3.className = "denied"
            }
            resultsDiv.appendChild(allowedH3)

            const respH3 = document.createElement("h3")
            respH3.innerHTML = "Response"
            resultsDiv.appendChild(respH3)

            highlight(JSON.stringify(data.response, null, 4), "json", function(resp) {
                const respCode = document.createElement("code")
                respCode.innerHTML = resp
                resultsDiv.appendChild(respCode)
            })
        }, null)
    }

    function onClear() {
        var subject = document.getElementById("subjectInput")
        var action = document.getElementById("actionInput")
        var resource = document.getElementById("resourceInput")
        var body = document.getElementById("bodyInput")

        subject.value = ""
        action.value = ""
        resource.value = ""
        body.value = ""
        editWatcherIndex = null

        const resultsDiv = document.getElementById("results")
        resultsDiv.innerHTML = ''
    }

    function onWatch() {
      var watchDiv = document.getElementById("watching")
      var subject = document.getElementById("subjectInput").value
      var action = document.getElementById("actionInput").value
      var resource = document.getElementById("resourceInput").value
      var body = document.getElementById("bodyInput").value
      var newWatcher = {subject, action, resource, body}

      if (Number.isInteger(editWatcherIndex)) {
        watcherList[editWatcherIndex] = newWatcher
      } else {
        watcherList.push(newWatcher)
      }

      editWatcherIndex = null

      renderAllWatchers()

      // Force a new set of decisions
      lastBundleCount = -1
      toggleModal()
    }

    function deleteWatcher(index) {
      if (Number.isInteger(index)) {
        watcherList.splice(index, 1)
      }

      renderAllWatchers()
    }

    function editWatcher(num) {
        editWatcherIndex = num

        var subject = getWatchedAttribute(num, "subject")
        var action = getWatchedAttribute(num, "action")
        var resource = getWatchedAttribute(num, "resource")
        var body = getWatchedAttribute(num, "body")

        document.getElementById("subjectInput").value = subject
        document.getElementById("actionInput").value = action
        document.getElementById("resourceInput").value = resource
        document.getElementById("bodyInput").value = body

        toggleModal('add_request_modal')
    }

    function getWatchedAttribute(num, attr) {
        const node = document.evaluate(`//td[@data-watcher='${num}' and @data-watcher-item='${attr}']`, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue
        return node.innerHTML
    }

    function watchUpdater() {
        // Call this function exactly once to start the watch updater. It will
        // schedule itself to run at regular intervals.

        // Schedule ourselves to re-run first, in case there is an exception.
        setTimeout(() => {
            watchUpdater()
        }, WATCHER_INTERVAL_MS);

        bundle_count(function(count) {
            // Nothing has changed, so we don't need to update anything.
            if (count == lastBundleCount) { return }
            lastBundleCount = count
            onBundleChange()

        })

    }

    function onBundleChange() {
        var xpathIter = document.evaluate("//td[@data-watcher and @data-watcher-item='allowed']", document, null, XPathResult.ANY_TYPE, null)
        while (true) {
            var node = xpathIter.iterateNext()
            if (node == null) { break }
            var num = Number(node.getAttribute("data-watcher"))

            var subject = getWatchedAttribute(num, "subject")
            var action = getWatchedAttribute(num, "action")
            var resource = getWatchedAttribute(num, "resource")
            var body = getWatchedAttribute(num, "body")

            getDecision(subject, action, resource, body, function(code, data, user) {
                if (code >= 400) {
                    user.innerHTML = "ERROR"
                    console.log(`got error code ${code}, result was: `, data)
                    return
                }

                if (data.allowed) {
                    user.innerHTML = `<p style="text-align: center;" class=allowed>allowed</p>`
                } else {
                    user.innerHTML = `<p style="text-align:center;" class=denied>denied</p>`
                }
            }, node)
        }

        control_allowed = document.getElementById("allow_das_control").checked

        // We also want the 'remove', 'copy', and 'sample' buttons to be
        // able to be enabled and disabled by policies.
        //
        // The relevant policy request include only the resource, which
        // will be a path such as
        //
        //     "entz-playground/buttons/samples"
        //
        // Or
        //
        //     entz-playground/buttons/remove"
        //
        // Note that these buttons don't get enabled or disabled
        // individually, but rather as a group.
        //
        // WARNING: this is not a secure way of implementing entitlements -
        // the data to which access is being controlled lives in the
        // browser on the client-side, and so does this code. This is a
        // pretty demo, NOT a demonstration of the correct way to implement
        // entitlements.

        // sample buttons
        if (control_allowed) {
            getDecision(null, null, "/entz-playground/buttons/samples", null, function (code, data, user) {
                    if (code >= 400) {
                        user.innerHTML = "ERROR"
                        console.log(`got error code ${code}, result was: `, data)
                        return
                    }
                    var buttons = document.getElementsByClassName("sample_button")
                    for (var i = 0 ; i < buttons.length; i++) {
                        buttons[i].disabled = !data.allowed
                    }
            }, null)

            // copy buttons
            getDecision(null, null, "/entz-playground/buttons/copy", null, function (code, data, user) {
                    if (code >= 400) {
                        user.innerHTML = "ERROR"
                        console.log(`got error code ${code}, result was: `, data)
                        return
                    }
                    var buttons = document.getElementsByClassName("copy_button")
                    for (var i = 0 ; i < buttons.length; i++) {
                        buttons[i].disabled = !data.allowed
                    }
            }, null)

            // remove buttons
            getDecision(null, null, "/entz-playground/buttons/remove", null, function (code, data, user) {
                    if (code >= 400) {
                        user.innerHTML = "ERROR"
                        console.log(`got error code ${code}, result was: `, data)
                        return
                    }
                    var buttons = document.getElementsByClassName("remove_button")
                    for (var i = 0 ; i < buttons.length; i++) {
                        buttons[i].disabled = !data.allowed
                    }
            }, null)

        } else {
            var buttons = document.getElementsByClassName("sample_button")
            for (var i = 0 ; i < buttons.length; i++) {
                buttons[i].disabled = false
            }

            var buttons = document.getElementsByClassName("copy_button")
            for (var i = 0 ; i < buttons.length; i++) {
                buttons[i].disabled = false
            }

            var buttons = document.getElementsByClassName("remove_button")
            for (var i = 0 ; i < buttons.length; i++) {
                buttons[i].disabled = false
            }
        }

        // update the bundle timestamp // TODO
        bundle_timestamp(function(ts) {
          refreshedTimestamp = new Date(ts)
        })
    }

    function timeUpdater() {
        // Schedule ourselves to re-run first, in case there is an exception.
        setTimeout(() => {
            timeUpdater()
        }, 200);

        var deltaDiv = document.getElementById("bundleUpdateDelta")
        // Until the first time we get a bundle timestamp, this will
        // throw an exception. That's OK though, since we already
        // scheduled ourself to run again later.
        var delta = Math.round(((new Date()) - refreshedTimestamp) / 1000)
        deltaDiv.innerHTML = `Last updated: ${delta} seconds ago`

        // Update the CSS class of our div to color code based on how long it's
        // been since we got a bundle update.
        deltaDiv.className = "timedelta_short"
        if (delta > TIMEDELTA_MEDIUM) {
            deltaDiv.className = "timedelta_medium"
        }
        if (delta > TIMEDELTA_LONG) {
            deltaDiv.className = "timedelta_long"
        }
    }

    function toggleModal(id) {
      var backdrop = document.getElementById('popup_modal_background')

      if (!id) {
          backdrop.style.display = 'none'
          const modals = document.getElementsByClassName('popup_modal')
          for (var i = 0; i < modals.length; i++) {
            modals[i].style.display = 'none'
          }
          onClear()
          return
      }

      var modalDiv = document.getElementById(id)
      const displayStyle = (modalDiv.style.display === 'none' ? 'block' : 'none')
      modalDiv.style.display = displayStyle
      backdrop.style.display = displayStyle

      if (displayStyle === 'none') {
        onClear()
      }
    }

    window.onload = () => {
      watchUpdater()
      onBundleChange()
      renderAllWatchers()
      timeUpdater()
      toggleModal('introduction_modal')
    }
</script>

<style>
  :root {
    --primary-color: #137cbd;
    --secondary-color: #394B59;
    --success-color: #0f9960;
    --warning-color: #d9822b;
    --danger-color: #db3737;
    --gray-color: #99a6b138;
    --text-color: #182026;
    --background-color: #E2E8EC;
    --white: #FFFFFF;
  }

  body {
    font-family: Arial, Helvetica, sans-serif;
    color: var(--text-color);
    background-color: var(--background-color);
  }

  button {
    background-color: var(--gray-color);
    display: -webkit-inline-box;
    display: -ms-inline-flexbox;
    display: inline-flex;
    -webkit-box-orient: horizontal;
    -webkit-box-direction: normal;
    -ms-flex-direction: row;
    flex-direction: row;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    padding: 5px 10px;
    text-align: left;
    vertical-align: middle;
    min-height: 30px;
    min-width: 30px;
  }

  button.primary {
    background-color: var(--primary-color);
    color: var(--white);
  }

  button.secondary {
    background-color: var(--secondary-color);
    color: var(--white);
  }

  label[for] {
    cursor: pointer;
  }

  input:not([type='checkbox']) {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background: var(--white);
    border: none;
    border-radius: 3px;
    -webkit-box-shadow: 0 0 0 0 rgb(19 124 189 / 0%), 0 0 0 0 rgb(19 124 189 / 0%), inset 0 0 0 1px rgb(16 22 26 / 15%), inset 0 1px 1px rgb(16 22 26 / 20%);
    box-shadow: 0 0 0 0 rgb(19 124 189 / 0%), 0 0 0 0 rgb(19 124 189 / 0%), inset 0 0 0 1px rgb(16 22 26 / 15%), inset 0 1px 1px rgb(16 22 26 / 20%);
    color: var(--text-color);
    font-size: 14px;
    font-weight: 400;
    height: 30px;
    line-height: 30px;
    outline: none;
    padding: 0 10px;
    -webkit-transition: -webkit-box-shadow 100ms cubic-bezier(0.4, 1, 0.75, 0.9);
    transition: -webkit-box-shadow 100ms cubic-bezier(0.4, 1, 0.75, 0.9);
    transition: box-shadow 100ms cubic-bezier(0.4, 1, 0.75, 0.9);
    transition: box-shadow 100ms cubic-bezier(0.4, 1, 0.75, 0.9), -webkit-box-shadow 100ms cubic-bezier(0.4, 1, 0.75, 0.9);
    vertical-align: middle;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 10px;
  }

  .watcher.control_buttons {
    text-align: right;
  }

  .watcher p {
    padding: 5px;
    text-transform: uppercase;
    font-weight: 600;
  }

  .allowed {
      background-color: var(--success-color);
      color: white;
  }
  .denied {
      background-color: var(--danger-color);
      color: white;
  }
  .timedelta_short {
      background-color: var(--success-color);
      color: white;
  }
  .timedelta_medium {
      background-color: var(--warning-color);
      color: white;
  }
  .timedelta_long {
      background-color: var(--danger-color);
      color: white;
  }

  #bundleUpdateDelta {
    padding: 10px;
    border-radius: 3px;
  }

  .body_wrapper {
    max-width: 800px;
    margin: 30px auto;
    padding: 10px;
  }

  .popup_modal {
    position: fixed;
    max-height: 80vh;
    box-sizing: border-box;
    padding: 30px;
    display: block;
    background: white;
    border: 1px solid black;
    margin: auto;
    max-width: 600px;
    left: 0;
    right: 0;
    z-index: 1;
  }

  .popup_modal .close_button::after {
    content: '×';
    position: absolute;
    top: 0;
    right: 0;
    padding: 45px 30px 20px 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.5em;
  }

  button {
    cursor: pointer;
  }

  table {
    width: 100%;
  }

  th {
    text-align: left;
  }

  #popup_modal_background {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--gray-color);
    z-index: 0;
  }

  .footer {
    position: fixed;
    background: var(--gray-color);
    left: 0;
    right: 0;
    bottom: 0;
    padding: 10px;
  }

  .flex_wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .info_icon {
    font-size: 22px;
    vertical-align: top;
    color: var(--primary-color);
    text-decoration: none;
    cursor: pointer;
  }
</style>

<div class="body_wrapper">
  <div id="popup_modal_background" style="display: none;" onClick="event.stopPropagation(); toggleModal()"></div>
  <h1>Entitlements Playground <a class="info_icon" onClick="event.preventDefault(); toggleModal('introduction_modal')">ⓘ</a></h1>

    <div class="popup_modal" id="introduction_modal" style="display: none;" onClick="event.stopPropagation()">
      <div class="close_button" onClick="toggleModal('introduction_modal')"></div>
      <h2>Instructions</h2>

      <p>Welcome to the Entitlements Playground! This tool allows you to
      experiment with different requests using the Entitlements object model.
      Start filling the form fields below and then click the <b>Preview</b> button
      to work on the object model. Try using the row of sample buttons above the
      form to pre-populate the fields with some example values.</p>

      <p>You can also watch a request. When you click the <b>Watch</b> button
      below, the request data will be stored in the <b>Watch List</b> table below.
      The <b>Allowed?</b> column will update in real-time according to policy
      changes made in the DAS to show whether that request would be allowed or
      denied. You can use the <b>Copy</b> button to copy a row back into the form
      fields, allowing you to <b>Preview</b> it again and see the full response
      from the DAS. The <b>Remove</b> button will delete the row from the
      table.</p>

      <p>When "Allow DAS policy to control buttons" is checked, the sample
      buttons above the form, and the <b>Copy</b> and <b>Remove</b> buttons for
      each row in the <b>Watch List</b> table are controlled by Entitlements
      policies. Each group of buttons can be enabled or disabled by creating a
      policy to allow or deny access to the
      <code>/entz-playground/buttons/samples</code>,
      <code>/entz-playground/buttons/copy</code>, or
      <code>/entz-playground/buttons/remove</code> respectively. </p>

      <p><b>TIP:</b>Because the DAS has a default-deny policy, these buttons will
      be disabled until you create a policy in your DAS that allows them.</p>
    </div>

    <div class="popup_modal" id="add_request_modal" style="display: none;" onClick="event.stopPropagation()">
      <div class="close_button" onClick="toggleModal('add_request_modal')"></div>
      <h2>Edit Watcher</h2>

      <div id="requestEntry">
        <label>Subject</label><br />
        <input width=500 id="subjectInput" type="text" name="subject"><br />
        <label>Action</label><br />
        <input width=500 id="actionInput" type="text" name="action"><br />
        <label>Resource</label><br />
        <input width=500 id="resourceInput" type="text" name="resource"><br />
        <label>Body</label><br />
        <input width=500 id="bodyInput" type="text" name="body"><br /><br />
        <div class="flex_wrapper">
          <div>
            <button class="primary" type="button" onclick="onPreview()">Preview</button>
            <button class="secondary" type="button" onclick="onClear()">Clear form</button>
          </div>
          <button class="primary" type="button" onclick="onWatch()">Create watcher</button>
        </div>
        <div id="results"></div>
      </div>
    </div>

    <div id="watching">
      <h2 class="flex_wrapper">
        Watch List <button class="primary" onClick="toggleModal('add_request_modal')">New watcher</button>
      </h2>
      <input type="checkbox" id="allow_das_control" onclick="onBundleChange()">
      <label for="allow_das_control">Allow DAS policy to control buttons.</label><br/><br/><br/>
      <table id="watchingTable">
        <tr><th>Subject</th><th>Action</th><th>Resource</th><th>Body</th><th>Allowed?</th><th></th><th></th></tr>
      </table>
    </div>

    <div class="footer">
      <div id="bundleUpdateDelta" class="body_wrapper"></div>
    </div>
</div>
